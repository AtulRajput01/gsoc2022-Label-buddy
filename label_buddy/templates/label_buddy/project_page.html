{% extends 'base.html' %}

{% load static%}

{% load crispy_forms_tags %}

{% block head_files %}
    {{ block.super }}
    <link href="{% static 'css/project_page.css' %}" rel="stylesheet" type="text/css">
    <script type="text/javascript"> 
        var project_id = "{{ project.id }}";
        var django_csrf_token = "{{ csrf_token }}";
    </script>
    <script src="{% static '/js/project_page.js'%}"></script>
{% endblock %}

{% block title %} &#9702; {{project.title}} {% endblock %}

{% block breadcrumbs %}
    <ol style="margin-top: 1%;"  class="breadcrumb bg-light py-0">
        <li class="breadcrumb-item"><a class="my-link" href="{% url 'index_page' %}"><i class="fas fa-home"></i></a></li>
        <li class="breadcrumb-item active" aria-current="page">
            {% if project.title %}
                {{ project.title}}
            {% else %}
                Project #{{project.id}}
            {% endif %}
        </li>
    </ol>
{% endblock %}

{% block navbar_buttons %}
{% endblock %}

{% block content %}
    {{ block.super }}
    <div style="display: none;" class="alert alert-success alert-dismissible fade" id="export_success_alert">
        <i style="margin-right: .5%;" class="fas fa-check-circle"></i>
        <strong id="success_message"></strong>
        <button type="button" class="close" onclick="hideAlert(this);" aria-label="Close" value="SUCCESS">
        <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div style="display: none;" class="alert alert-danger alert-dismissible fade" id="export_fail_alert" role="alert">
        <i style="margin-right: .5%;" class="fas fa-times-circle"></i>
        <strong id="fail_message"></strong>
        <button type="button" class="close" onclick="hideAlert(this);" aria-label="Close" value="DANGER">
        <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% comment %}
        <!-- <div class="top-div">
            <a href="{% url 'index_page' %}"><img style="border: 2px solid #74deed; float: left;" src="{{ project.logo.url }}" width="30" height="30" href="{% url 'index_page' %}" data-toggle="tooltip" data-target="top" title="{{ project.title }}" class="rounded-circle"></a>
            <i style="margin-top: .5%;" class="fas fa-angle-right fa-xs top-icons"></i>
            <a data-toggle="tooltip" data-target="top" title="Project instructions" class="top-icons"><i style="cursor: pointer;" data-toggle="modal" data-target="#projectModal" class="fas fa-info"></i></a>
            <a data-toggle="tooltip" data-target="top" title="Project description" style="margin-left: 1%;" class="top-icons"><i style="cursor: pointer;" data-toggle="modal" data-target="#descriptionModal" class="fas fa-question-circle"></i></a>
            {% if project.users_can_see_other_queues %}
                <span data-toggle="tooltip" data-placement="bottom" offset=.5 title="All task are shown" style="float: right; margin-top: .2%;">
                        <b>Public tasks: <i style="color:green" class="fas fa-check-circle" aria-hidden="true"></i></b>
                </span>
            {% else %}
                <span data-toggle="tooltip" data-placement="bottom" title="Annotate only assigned tasks" style="float: right; margin-top: .2%;">
                    <b>Public tasks: <i style="color:red" class="fas fa-exclamation-circle" aria-hidden="true"></i></b>
                </span>
            {% endif %}
        </div> -->
    {% endcomment %}
    {% if tasks_count_no_filter > 0 %}
        <h2 class="headers-page">
            {{ project.title }}
            <sup>
                <i style="cursor: pointer; color: #74deed;" data-toggle="modal" data-target="#projectModal" class="far fa-question-circle tooltip-icons fa-xs"></i>
            </sup>
        </h2>
        <div id="header-div">
            {% if user in project.managers.all %}
                <button style="color: black; float: right;" data-toggle="modal" data-target="#exportModal" class="btn my-button">
                    <i style="margin-right: 10%;" class="fas fa-file-export"></i> Export
                </button>
                <button style="color: black; float: right; margin-right: .5%;" data-toggle="modal" data-target="#importModal" class="btn my-button">
                    <i style="margin-right: 10%;" class="fas fa-cloud-upload-alt"></i> Import
                </button>
            {% endif %}
            {% comment %}
                <!-- <a style="color: black; margin-right: .5%; float: left;" data-toggle="tooltip" data-placement="top" title="Back to projects page" href="{% url 'index_page' %}" class="btn my-button"><i style="margin-right: 10%;" class="fas fa-caret-left"></i> Back</a> -->
            {% endcomment %}
            {% include "project_page_filters.html" %}
        </div>
        <div class="table-div">
            <!--Table-->
            <table class="table table-bordered">
            <!--Table head-->
            <thead>
                <tr>
                    <th style="width: 100px;" title="Task ID"><i class="fas fa-hashtag my-table-header"></i> ID</th>
                    <th><i class="fa fa-caret-right my-table-header" aria-hidden="true"></i> Title</th>
                    <th><i class="fa fa-paint-brush my-table-header" aria-hidden="true"></i> Annotations done</th>
                    <th><i class="fas fa-users my-table-header"></i> Annotated by</th>
                    <th><i class="fas fa-file-audio my-table-header"></i> Audio file</th>
                    <th style="width: 170px;"><i class="fas fa-check-circle my-table-header"></i> Status</th>
                    <th style="width: 170px;"><i class="fas fa-check-circle my-table-header"></i> Review status</th>
                    {% if user in project.annotators.all %}
                        <th><i class="fas fa-paint-brush my-table-header"></i> Annotated by you</th>
                    {% endif %}
                    <th data-toggle="tooltip" data-placement="left" title="Annotate/Review task" style="width: 110px;"><i class="fas fa-list my-table-header"></i> Options</th>
                    {% if user in project.managers.all %}
                        <th data-toggle="tooltip" data-placement="left" title="Delete task" style="width: 50px; text-align: center;">
                            <i style="cursor: default;" class="fas fa-trash-alt tooltip-icons"></i>
                        </th>
                    {% endif %}
                </tr>
            </thead>
            <!--Table head-->
            {% for task in page_obj %}
                <!--Table body-->
                <tbody>
                    <tr>
                        <td>{% get_table_id page_obj.number tasks_per_page forloop.counter %}</td>
                        {% if task.file %}
                            <td data-toggle="tooltip" data-placement="top" title="{{ task.original_file_name }}" class="table-title">{{ task.original_file_name }}</td>
                        {% else %}
                            <td><b>-</b></td>
                        {% endif %}
                        <td><b>{{ count_annotations_for_task|get_item:task.id }}</b></td>
                        <td>
                            {% if users_annotated|get_item:task.id %}
                                {% for obj in users_annotated|get_item:task.id %}
                                    {% if obj == user %}
                                        <img data-toggle="tooltip" data-placement="top" style="border: 2px solid #74deed;" src="{{ obj.avatar.url }}" width="27" height="27" title="You" class="rounded-circle">
                                    {% else %}
                                        <img data-toggle="tooltip" data-placement="top" src="{{ obj.avatar.url }}" width="25" height="25" title="{{ obj.username }}" class="rounded-circle">
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <b>-</b>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.file %}
                                <audio title="{{ task.file }}" class="audio-player" controls
                                    src="{{ task.file.url }}">
                                        Your browser does not support the
                                        <code>audio</code> element.
                                </audio>
                            {% else %}
                                <b>-</b>
                            {% endif %}
                        </td>
                        {% if task.status == labeled %}
                            <td><i data-toggle="tooltip" data-placement="top" data-title="Labeled" style="color: #5cb85c" class="fas fa-check-circle tooltip-icons" aria-hidden="true"></i></td>
                        {% else %}
                            <td><i data-toggle="tooltip" data-placement="top" data-title="Unlabeled" style="color: #d9534f" class="fas fa-exclamation-circle tooltip-icons" aria-hidden="true"></i></td>
                        {% endif %}
                        
                        {% if task.review_status == reviewed %}
                            <td><i data-toggle="tooltip" data-placement="top" data-title="All annotations reviewed" style="color: #5cb85c" class="fas fa-check-circle tooltip-icons" aria-hidden="true"></i></td>
                        {% else %}
                            <td><i data-toggle="tooltip" data-placement="top" data-title="Some annotations are unreviewed" style="color: #d9534f" class="fas fa-exclamation-circle tooltip-icons" aria-hidden="true"></i></td>
                        {% endif %}

                        {% if user in project.annotators.all %}
                            {% if annotated_tasks|get_item:task.id %}
                                <td><i data-toggle="tooltip" data-placement="top" data-title="Task annotated by you" style="color: #5cb85c" class="fas fa-check-circle tooltip-icons" aria-hidden="true"></i></td>
                            {% else %}
                                <td><i data-toggle="tooltip" data-placement="top" data-title="Task not annotated by you" style="color: #d9534f" class="fas fa-exclamation-circle tooltip-icons" aria-hidden="true"></i></td>
                            {% endif %}
                        {% endif %}

                        <td style="text-align: center;">
                            {% if project.users_can_see_other_queues %}
                                {% if user in project.annotators.all and user in project.reviewers.all %}
                                    <a id="annotate-link" href="{% url 'annotation_page' project.id task.id %}">
                                        <i style="cursor: pointer;" data-toggle="tooltip" data-placement="top" data-title="Annotate task" class="fas fa-paint-brush tooltip-icons"></i> </i>
                                    </a>
                                    <b>/</b>
                                    <a id="review-link" href="{% url 'list_task_annotations' project.id task.id %}">
                                        <i style="cursor: pointer;" data-toggle="tooltip" data-placement="top" data-title="Review task" class="fas fa-comment-dots tooltip-icons"></i>
                                    </a>
                                {% else %}
                                    {% if user in project.annotators.all %}
                                        <a style="margin-right: 0%;" id="annotate-link" href="{% url 'annotation_page' project.id task.id %}">
                                            <i style="cursor: pointer;" data-toggle="tooltip" data-placement="top" data-title="Annotate task" class="fas fa-paint-brush tooltip-icons"></i> </i>
                                        </a>
                                    {% elif user in project.reviewers.all %}
                                        <a style="margin-left: 0%;" id="review-link" href="{% url 'list_task_annotations' project.id task.id %}">
                                            <i style="cursor: pointer;" data-toggle="tooltip" data-placement="top" data-title="Review task" class="fas fa-comment-dots tooltip-icons"></i>
                                        </a>
                                    {% else %}
                                        <b>-</b>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                {% if user in project.annotators.all and user in task.assigned_to.all and user in project.reviewers.all %}
                                    <a id="annotate-link" href="{% url 'annotation_page' project.id task.id %}">
                                        <i style="cursor: pointer;" data-toggle="tooltip" data-placement="top" data-title="Annotate task" class="fas fa-paint-brush tooltip-icons"></i> </i>
                                    </a>
                                    <b>/</b>
                                    <a id="review-link" href="{% url 'list_task_annotations' project.id task.id %}">
                                        <i style="cursor: pointer;" data-toggle="tooltip" data-placement="top" data-title="Review task" class="fas fa-comment-dots tooltip-icons"></i>
                                    </a>
                                {% else %}
                                    {% if user in project.annotators.all and user in task.assigned_to.all or not task.assigned_to.exists %}
                                        <a style="margin-right: 0%;" id="annotate-link" href="{% url 'annotation_page' project.id task.id %}">
                                            <i style="cursor: pointer;" data-toggle="tooltip" data-placement="top" data-title="Annotate task" class="fas fa-paint-brush tooltip-icons"></i> </i>
                                        </a>
                                    {% elif user in project.reviewers.all %}
                                        <a style="margin-left: 0%;" id="review-link" href="{% url 'list_task_annotations' project.id task.id %}">
                                            <i style="cursor: pointer;" data-toggle="tooltip" data-placement="top" data-title="Review task" class="fas fa-comment-dots tooltip-icons"></i>
                                        </a>
                                    {% else %}
                                        <b data-toggle="tooltip" data-placement="top" title="Assigned to {{ task.assigned_to.all.0.email }}">-</b>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        </td>
                        {% if user in project.managers.all %}
                            <td style="text-align: center;">
                                <a style="color:  #d9534f;" href="{% url 'delete_task' project.id task.id %}">
                                    <i style="cursor: pointer;" data-toggle="tooltip" data-placement="top" data-title="Delete {{ task.original_file_name }}" class="fas fa-times-circle tooltip-icons"></i>
                                </a>
                            </td>
                        {% endif %}
                        
                    </tr>
                </tbody>
                <!--Table body-->
            {% endfor %}
        </table>
    {% else %}
        <h2 style="text-align:center; margin-top: .5%;">
            {% if user in project.managers.all %}
                No tasks for project {{ project.title }}. Please <a class="my-link" data-toggle="modal" data-target="#importModal" href="">import</a> some data.
            {% else %}
                No tasks for project {{ project.title }} yet.
            {% endif %}
        </h2>
    {% endif%}

    {% if tasks_count_filtered > tasks_per_page %}
        {% include "pagination.html" %}
    {% endif %}

    {% include "project_modals.html" %}
    {% include "import_modal.html" %}
    {% include "export_modal.html" %}
{% endblock %}